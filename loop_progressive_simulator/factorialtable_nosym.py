import numpy as np
import numba

# Table of values of log(n!)
LOG_FACTORIAL_TABLE = np.array([
    0.000000000000000,
    0.0,
    0.6931471805599453,
    1.791759469228055,
    3.1780538303479453,
    4.787491742782046,
    6.579251212010101,
    8.525161361065415,
    10.60460290274525,
    12.80182748008147,
    15.104412573075518,
    17.502307845873887,
    19.98721449566189,
    22.552163853123425,
    25.191221182738683,
    27.899271383840894,
    30.671860106080675,
    33.50507345013689,
    36.39544520803305,
    39.339884187199495,
    42.335616460753485,
    45.38013889847691,
    48.47118135183523,
    51.60667556776438,
    54.784729398112326,
    58.003605222980525,
    61.26170176100201,
    64.55753862700634,
    67.88974313718154,
    71.25703896716801,
    74.65823634883017,
    78.09222355331532,
    81.55795945611504,
    85.05446701758153,
    88.5808275421977,
    92.13617560368711,
    95.71969454214322,
    99.33061245478744,
    102.96819861451382,
    106.63176026064347,
    110.3206397147574,
    114.0342117814617,
    117.77188139974507,
    121.53308151543864,
    125.3172711493569,
    129.12393363912722,
    132.95257503561632,
    136.80272263732638,
    140.67392364823428,
    144.5657439463449,
    148.47776695177305,
    152.40959258449737,
    156.3608363030788,
    160.33112821663093,
    164.3201122631952,
    168.32744544842768,
    172.35279713916282,
    176.39584840699737,
    180.45629141754378,
    184.5338288614495,
    188.6281734236716,
    192.7390472878449,
    196.86618167288998,
    201.00931639928152,
    205.1681994826412,
    209.34258675253685,
    213.53224149456327,
    217.73693411395422,
    221.95644181913033,
    226.1905483237276,
    230.43904356577696,
    234.70172344281826,
    238.97838956183432,
    243.2688490029827,
    247.57291409618688,
    251.8904022097232,
    256.22113555000954,
    260.5649409718632,
    264.92164979855283,
    269.29109765101987,
    273.67312428569375,
    278.0675734403662,
    282.47429268763045,
    286.89313329542705,
    291.32395009427034,
    295.76660135076065,
    300.22094864701415,
    304.6868567656687,
    309.16419358014696,
    313.6528299498791,
    318.15263962020936,
    322.6634991267262,
    327.18528770377526,
    331.71788719692853,
    336.2611819791985,
    340.8150588707991,
    345.3794070622669,
    349.9541180407703,
    354.5390855194409,
    359.1342053695755,
    363.7393755555636,
    368.35449607240486,
    372.97946888568913,
    377.6141978739188,
    382.2585887730602,
    386.91254912321773,
    391.5759882173298,
    396.24881705179166,
    400.9309482789159,
    405.622296161145,
    410.32277652693745,
    415.0323067282498,
    419.7508055995449,
    424.4781934182572,
    429.2143918666517,
    433.9593239950149,
    438.7129141861213,
    443.47508812091905,
    448.2457727453847,
    453.02489623849624,
    457.8123879812783,
    462.608178526875,
    467.41219957160826,
    472.2243839269807,
    477.04466549258575,
    481.8729792298881,
    486.70926113683953,
    491.5534482232981,
    496.40547848721775,
    501.2652908915794,
    506.132825342035,
    511.0080226652362,
    515.8908245878225,
    520.7811737160442,
    525.6790135159952,
    530.5842882944336,
    535.4969431801696,
    540.4169241059977,
    545.344177791155,
    550.2786517242856,
    555.220294146895,
    560.1690540372731,
    565.1248810948744,
    570.0877257251343,
    575.0575390247103,
    580.0342727671309,
    585.0178793888392,
    590.008311975618,
    595.0055242493821,
    600.0094705553275,
    605.0201058494238,
    610.0373856862387,
    615.061266207085,
    620.0917041284775,
    625.1286567308912,
    630.1720818478104,
    635.22193785506,
    640.2781836604083,
    645.3407786934353,
    650.4096828956555,
    655.4848567108893,
    660.5662610758737,
    665.6538574111062,
    670.7476076119129,
    675.8474740397371,
    680.9534195136376,
    686.0654073019941,
    691.1834011144109,
    696.3073650938142,
    701.4372638087373,
    706.5730622457876,
    711.7147258022902,
    716.8622202791037,
    722.0155118736014,
    727.174567172816,
    732.3393531467394,
    737.5098371417776,
    742.6859868743513,
    747.8677704246434,
    753.0551562304842,
    758.2481130813744,
    763.4466101126402,
    768.650616799717,
    773.8601029525585,
    779.0750387101674,
    784.2953945352457,
    789.5211412089589,
    794.7522498258135,
    799.9886917886435,
    805.2304388037031,
    810.4774628758636,
    815.7297363039102,
    820.9872316759379,
    826.2499218648428,
    831.5177800239061,
    836.7907795824698,
    842.0688942417003,
    847.3520979704383,
    852.6403650011329,
    857.9336698258574,
    863.2319871924054,
    868.5352921004645,
    873.8435597978657,
    879.1567657769075,
    884.4748857707517,
    889.7978957498901,
    895.1257719186797,
    900.458490711945,
    905.7960287916463,
    911.1383630436111,
    916.4854705743286,
    921.8373287078047,
    927.1939149824767,
    932.5552071481861,
    937.921183163208,
    943.2918211913357,
    948.6670995990198,
    954.0469969525603,
    959.4314920153495,
    964.8205637451659,
    970.2141912915183,
    975.6123539930361,
    981.0150313749084,
    986.4222031463685,
    991.8338491982236,
    997.249949600428,
    1002.6704845997002,
    1008.0954346171816,
    1013.5247802461361,
    1018.9585022496904,
    1024.3965815586137,
    1029.8389992691355,
    1035.2857366408018,
    1040.7367750943674,
    1046.1920962097252,
    1051.6516817238694,
    1057.115513528895,
    1062.58357367003,
    1068.0558443437017,
    1073.5323078956333,
    1079.0129468189753,
    1084.4977437524658,
    1089.9866814786226,
    1095.4797429219632,
    1100.9769111472565,
    1106.478169357801,
    1111.9835008937334,
    1117.4928892303615,
    1123.0063179765264,
    1128.523770872991,
    1134.0452317908532,
    1139.570684729985,
    1145.1001138174965,
    1150.6335033062242,
    1156.1708375732428,
    1161.7121011184013,
    1167.2572785628809,
    1172.806354647776,
    1178.3593142326977,
    1183.916142294397,
    1189.4768239254126,
    1195.0413443327354,
    1200.6096888364966,
    1206.1818428686745,
    1211.7577919718208,
    1217.337521797807,
    1222.9210181065887,
    1228.508266764989,
    1234.0992537455,
    1239.6939651251018,
    1245.2923870841003,
    1250.89450590498,
    1256.500307971276,
    1262.109779766461,
    1267.7229078728492,
    1273.3396789705157,
    1278.9600798362328,
    1284.5840973424201,
    1290.2117184561107,
    1295.842930237932,
    1301.4777198411014,
    1307.116074510435,
    1312.757981581373,
    1318.4034284790164,
    1324.0524027171775,
    1329.7048918974463,
    1335.360883708266,
    1341.0203659240258,
    1346.6833264041618,
    1352.349753092274,
    1358.0196340152547,
    1363.6929572824263,
    1369.3697110846945,
    1375.0498836937115,
    1380.7334634610502,
    1386.42043881739,
    1392.1107982717142,
    1397.804530410517,
    1403.5016238970222,
    1409.2020674704129,
    1414.9058499450691
], dtype=np.float64)
max_n = len(LOG_FACTORIAL_TABLE) - 1


@numba.njit()
def log_factorial(n):
    if n <= max_n:
        return LOG_FACTORIAL_TABLE[n]
    else:
        f = LOG_FACTORIAL_TABLE[max_n]
        for i in range(max_n + 1, n + 1):
            f += np.log(i)
        return f


@numba.njit()
def mem_factorial(n):
    return np.exp(log_factorial(n))
